apiVersion: v1
kind: ServiceAccount
metadata:
  name: openshift4-monitoring-rules
  namespace: openshift-operators-redhat
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: openshift4-monitoring-rules
  namespace: openshift-operators-redhat
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: monitoring-rules-edit
subjects:
  - kind: ServiceAccount
    name: openshift4-monitoring-rules
---
apiVersion: espejote.io/v1alpha1
kind: ManagedResource
metadata:
  labels:
    app.kubernetes.io/name: openshift4-monitoring-rules
  name: openshift4-monitoring-rules
  namespace: openshift-operators-redhat
spec:
  context:
    - name: op_rules
      resource:
        apiVersion: monitoring.coreos.com/v1
        kind: PrometheusRule
        labelSelector:
          matchExpressions:
            - key: espejote.io/created-by
              operator: DoesNotExist
            - key: espejote.io/ignore
              operator: DoesNotExist
  serviceAccountRef:
    name: openshift4-monitoring-rules
  template: |
    local esp = import 'espejote.libsonnet';

    local renderer = import 'lib/openshift4-monitoring-rules/renderer_v1.libsonnet';
    local configGlobal = import 'lib/openshift4-monitoring-rules/config_v1.json';
    local configComponent = import 'openshift4-monitoring-rules/config.json';

    local opRules = esp.context().op_rules;

    [
      renderer.process(or, configGlobal, configComponent),
      for or in opRules
    ]
  triggers:
    - name: op_rules
      watchContextResource:
        name: op_rules
    - name: generated_rules
      watchResource:
        apiVersion: monitoring.coreos.com/v1
        kind: PrometheusRule
        labelSelector:
          matchExpressions:
            - key: espejote.io/created-by
              operator: In
              values:
                - openshift4-monitoring-rules
---
apiVersion: espejote.io/v1alpha1
kind: JsonnetLibrary
metadata:
  labels:
    app.kubernetes.io/name: openshift4-monitoring-rules
  name: openshift4-monitoring-rules
  namespace: openshift-operators-redhat
spec:
  data:
    config.json: |-
      {
          "ignoreNames": [
              "AlertmanagerConfigInconsistent"
          ]
      }
