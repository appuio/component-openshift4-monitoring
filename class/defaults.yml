parameters:
  openshift4_monitoring:
    namespace: openshift-monitoring
    # TODO: select based on reported OCP version once we have dynamic facts
    manifests_version: release-4.7
    =_cluster_monitoring_operator_version_map:
      # For release-4.7 we're using the old legacy commit hash
      # No idea what this points to exactly, -SG,2021-10-29.
      release-4.7: 45cb6f2942dff5afe17bbbf46f1eb6d3e7708f51
      release-4.8: release-4.8
      release-4.9: release-4.9
    =_etcd_operator_version_map:
      release-4.7: '' # not required for 4.7 since the cluster-monitoring-operator has the etcd rules
      release-4.8: release-4.9 # etcd-operator Jsonnet only available for 4.9
      release-4.9: release-4.9
    jsonnetfile_parameters:
      cmo_version: ${openshift4_monitoring:_cluster_monitoring_operator_version_map:${openshift4_monitoring:manifests_version}}
      etcd_version: ${openshift4_monitoring:_etcd_operator_version_map:${openshift4_monitoring:manifests_version}}
    defaultConfig:
      nodeSelector:
        node-role.kubernetes.io/infra: ''
    enableUserWorkload: false
    upstreamRules:
      networkPlugin: openshift-sdn
      elasticsearchOperator: true
      clusterSamplesOperator: true
    configs:
      prometheusK8s:
        externalLabels:
          cluster_id: ${cluster:name}
          tenant_id: ${cluster:tenant}
        retention: 8d
        volumeClaimTemplate:
          spec:
            resources:
              requests:
                storage: 50Gi
      prometheusOperator: {}
      alertmanagerMain:
        volumeClaimTemplate:
          spec:
            resources:
              requests:
                storage: 2Gi
      kubeStateMetrics: {}
      grafana: {}
      telemeterClient: {}
      k8sPrometheusAdapter: {}
      openshiftStateMetrics: {}
      thanosQuerier: {}
    configsUserWorkload:
      prometheusOperator: {}
      prometheus: ${openshift4_monitoring:configs:prometheusK8s}
      thanosRuler: {}
    alertManagerConfig:
      route:
        group_wait: 0s
        group_interval: 5s
        repeat_interval: 10m
      inhibit_rules:
        # Don't send warning or info if a critical is already firing
        - target_match_re:
            severity: warning|info
          source_match:
            severity: critical
          equal:
            - namespace
            - alertname
        # Don't send info if a warning is already firing
        - target_match_re:
            severity: info
          source_match:
            severity: warning
          equal:
            - namespace
            - alertname
    alerts:
      ignoreNames: []
      customAnnotations: {}
      patchRules:
        release-4.7:
          SystemMemoryExceedsReservation:
            for: 15m

    silence:
      schedule: '0 */4 * * *'
      serviceAccountName: prometheus-k8s
      servingCertsCABundleName: serving-certs-ca-bundle
      jobHistoryLimit:
        failed: 3
        successful: 3

    rules: {}
    images:
      oc:
        image: quay.io/appuio/oc
        tag: v4.6
