apiVersion: v1
data:
  silence: "#!/bin/bash\n\ncurl_opts=( https://alertmanager-main.openshift-monitoring.svc.cluster.local:9095/api/v2/silences\
    \ --cacert /etc/ssl/certs/serving-certs/service-ca.crt --header 'Content-Type:\
    \ application/json' --header \"Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\"\
    \ --resolve alertmanager-main.openshift-monitoring.svc.cluster.local:9095:$(getent\
    \ hosts alertmanager-operated.openshift-monitoring.svc.cluster.local | awk '{print\
    \ $1}' | head -n 1) --silent )\n\ncomment='Silence non syn alerts'\n\nread -d\
    \ '' body << EOF\n{\n  \"matchers\": [\n    {\n      \"name\": \"syn\",\n    \
    \  \"value\": \"\",\n      \"isRegex\": false\n    },\n    {\n      \"name\":\
    \ \"alertname\",\n      \"value\": \".+\",\n      \"isRegex\": true\n    }\n \
    \ ],\n  \"startsAt\": \"$(date -u +'%Y-%m-%dT%H:%M:%S')\",\n  \"endsAt\": \"$(date\
    \ -u +'%Y-%m-%dT%H:%M:%S' --date '+1 year')\",\n  \"createdBy\": \"Kubernetes\
    \ object `cronjob/silence` in the monitoring namespace\",\n  \"comment\": \"${comment}\"\
    \n}\nEOF\n\nid=$(curl \"${curl_opts[@]}\" | jq -r \".[] | select(.status.state\
    \ == \\\"active\\\") | select(.comment == \\\"${comment}\\\") | .id\" | head -n\
    \ 1)\n\nif [ -n \"${id}\" ]; then\n  body=$(echo \"${body}{\\\"id\\\":\\\"${id}\\\
    \"}\" | jq -s '.[0] * .[1]')\nfi\n\ncurl \"${curl_opts[@]}\" -XPOST -d \"${body}\"\
    \n"
kind: ConfigMap
metadata:
  annotations: {}
  labels:
    name: silence
  name: silence
  namespace: openshift-monitoring
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  annotations: {}
  labels:
    name: silence
  name: silence
  namespace: openshift-monitoring
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      completions: 1
      parallelism: 1
      template:
        metadata:
          labels:
            name: silence
        spec:
          containers:
            - args: []
              command:
                - /usr/local/bin/silence
              env: []
              image: quay.io/appuio/oc:v4.9
              imagePullPolicy: IfNotPresent
              name: silence
              ports: []
              stdin: false
              tty: false
              volumeMounts:
                - mountPath: /etc/ssl/certs/serving-certs/
                  name: ca-bundle
                  readOnly: true
                - mountPath: /usr/local/bin/
                  name: scripts
                  readOnly: true
          imagePullSecrets: []
          initContainers: []
          nodeSelector:
            node-role.kubernetes.io/infra: ''
          restartPolicy: Never
          serviceAccountName: prometheus-k8s
          terminationGracePeriodSeconds: 30
          volumes:
            - configMap:
                defaultMode: 288
                name: serving-certs-ca-bundle
              name: ca-bundle
            - configMap:
                defaultMode: 360
                name: silence
              name: scripts
  schedule: 0 */4 * * *
  successfulJobsHistoryLimit: 3
